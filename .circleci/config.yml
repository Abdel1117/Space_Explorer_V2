version: 2.1

jobs:
  build_and_test_backend:
    docker:
      - image: cimg/node:18.17.0
    steps:
      - checkout
      - run:
          name: Install Backend Dependencies
          command: npm install --prefix react_back_node
      - run:
          name: Run Backend Tests
          command: npm run test --prefix react_back_node

  build_and_test_frontend:
    docker:
      - image: cimg/node:18.17.0
    steps:
      - checkout
      - run:
          name: Install Frontend Dependencies
          command: npm install --prefix react_front
      - run:
          name: Run Frontend Tests
          command: npm test --prefix react_front
      - run:
          name: Build Frontend
          command: npm run build --prefix react_front

  build_and_push_docker_image:
    machine: true

  
    steps:
      - checkout
      - run:
          name: Install Docker Compose
          command: |
           sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
           sudo chmod +x /usr/local/bin/docker-compose

      - run:
          name: Login to Docker Hub
          command: | 
            echo "$DOCKERHUB_PASS" | docker login --username "$DOCKERHUB_USERNAME" --password-stdin
            docker-compose build
            docker-compose push
      - run:
          name: Push Docker Image to Docker Hub
          command: |
            docker push abdel11117/space-explorer:latest

  deploy_heroku:
    docker:
      - image: ubuntu:22.04

    steps:
      - checkout
      - run:
          name: Install Heroku CLI
          command: curl https://cli-assets.heroku.com/install.sh | sh
      - run:
          name: Login to Heroku
          command: HEROKU_API_KEY=${API_KEY_HEROKU} heroku container:login
      - run:
          name: Pull Docker Image from Docker Hub
          command: |
            docker pull abdel11117/space-explorer:latest
      - run:
          name: Tag Docker Image for Heroku
          command: |
            docker tag abdel11117/space-explorer:latest registry.heroku.com/<heroku-app-name>/web
      - run:
          name: Push Docker Image to Heroku
          command: |
            docker push registry.heroku.com/<space-explorer>/web
      - run:
          name: Release Docker Image on Heroku
          command: |
            HEROKU_API_KEY=${API_KEY_HEROKU} heroku container:release web -a <space-explorer>

workflows:
  version: 2
  build_and_test_workflow:
    jobs:
      - build_and_test_backend
      - build_and_test_frontend
      - build_and_push_docker_image:
          requires:
            - build_and_test_frontend
      - deploy_heroku:
          requires:
            - build_and_push_docker_image