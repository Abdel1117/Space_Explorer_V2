version: 2.1

jobs:
  build_and_test_backend:
    docker:
      - image: cimg/node:18.17.0
    steps:
      - checkout
      - run:
          name: Install Backend Dependencies
          command: npm install --prefix react_back_node
      - run:
          name: Run Backend Tests
          command: npm run test --prefix react_back_node

  build_and_test_frontend:
    docker:
      - image: cimg/node:18.17.0
    steps:
      - checkout
      - run:
          name: Install Frontend Dependencies
          command: npm install --prefix react_front
      - run:
          name: Run Frontend Tests
          command: npm test --prefix react_front
      - run:
          name: Build Frontend
          command: npm run build --prefix react_front

  build_and_push_services:
    machine:
      image: ubuntu-2004:202104-01
    steps:
      - checkout
      - run:
          name: Install Docker and Heroku CLI
          command: |
            curl https://cli-assets.heroku.com/install.sh | sh
            sudo apt-get update
            sudo apt-get install docker.io
      - run:
          name: Login to Docker Hub
          command: |
            echo "$DOCKERHUB_PASS" | docker login --username $DOCKERHUB_USERNAME --password-stdin
      - run:
          name: Build, Tag, and Push Backend to Docker Hub
          command: |
            docker build -f ./react_back_node/Dockerfile.space_explorer_back -t $DOCKERHUB_USERNAME/space-explorer-back:latest ./react_back_node
            docker push $DOCKERHUB_USERNAME/space-explorer-back:latest
      - run:
          name: Build, Tag, and Push Frontend to Docker Hub
          command: |
            docker build -f ./react_front/Dockerfile.space_explorer_front -t $DOCKERHUB_USERNAME/space-explorer-front:latest ./react_front
            docker push $DOCKERHUB_USERNAME/space-explorer-front:latest
      - run:
          name: Deploy Backend to Heroku
          command: |
            docker pull $DOCKERHUB_USERNAME/space-explorer-back:latest
            docker tag $DOCKERHUB_USERNAME/space-explorer-back:latest registry.heroku.com/space-explorer-back/web
            echo "$API_KEY_HEROKU" | docker login --username=_ --password-stdin registry.heroku.com
            docker push registry.heroku.com/space-explorer-back/web
            heroku container:release web -a space-explorer-back
      - run:
          name: Deploy Frontend to Heroku
          command: |
            docker pull $DOCKERHUB_USERNAME/space-explorer-front:latest
            docker tag $DOCKERHUB_USERNAME/space-explorer-front:latest registry.heroku.com/space-explorer-front/web
            echo "$API_KEY_HEROKU" | docker login --username=_ --password-stdin registry.heroku.com
            docker push registry.heroku.com/space-explorer-front/web
            heroku container:release web -a space-explorer-front

workflows:
  version: 2
  build_and_test_workflow:
    jobs:
      - build_and_test_backend
      - build_and_test_frontend
      - build_and_push_services:
          requires:
            - build_and_test_frontend
