version: 2.1

jobs:
  build_and_test_backend:
    docker:
      - image: cimg/node:18.17.0
    steps:
      - checkout
      - run:
          name: Install Backend Dependencies
          command: npm install --prefix react_back_node
      - run:
          name: Run Backend Tests
          command: npm run test --prefix react_back_node

  build_and_test_frontend:
    docker:
      - image: cimg/node:18.17.0
    steps:
      - checkout
      - run:
          name: Install Frontend Dependencies
          command: npm install --prefix react_front
      - run:
          name: Run Frontend Tests
          command: npm test --prefix react_front
      - run:
          name: Build Frontend
          command: npm run build --prefix react_front

    
  deploy_heroku:
    docker:
      - image: cimg/base:stable  # Use a base image that supports Docker and other necessary tools

    steps:
      - checkout
      - run:
          name: Install Required Tools
          command: |
            sudo apt-get update
            sudo apt-get install -y curl gnupg docker.io
            curl https://cli-assets.heroku.com/install.sh | sh
      - run:
          name: Login to Heroku
          command: HEROKU_API_KEY=${API_KEY_HEROKU} heroku container:login

      - run:
          name: Build and Push Docker Image to Heroku COntainer Registry
          command : |
              heroku container:push web -a space-explorer --recursive
     
      - run:
          name: Release Docker Image on Heroku
          command: |
            HEROKU_API_KEY=${API_KEY_HEROKU} heroku container:release web -a space-explorer

workflows:
  version: 2
  build_and_test_workflow:
    jobs:
      - build_and_test_backend
      - build_and_test_frontend
         
      - deploy_heroku:
          requires:
            - build_and_test_backend
            - build_and_test_frontend