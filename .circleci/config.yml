version: 2.1

orbs:
  node: circleci/node@4.1.0

jobs:
  build_and_test_backend:
    executor:
      name: node/default
      tag: '18.17.0'
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          app-dir: react_back_node
      - run:
          name: Run Backend Tests
          command: npm run test
          working_directory: react_back_node
    

  build_and_test_frontend:
    executor:
      name: node/default
      tag: '18.17.0'
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          app-dir: react_front
      - run:
          name: Run Frontend Tests
          command: npm test
          working_directory: react_front
      - run:
          name: Build Frontend
          command: npm run build
          working_directory: react_front
  deploy_docker:
  executor:
    name: node/default
    tag: '18.17.0'
  steps:
    - checkout
    - setup_remote_docker:
        version: 20.10.7
        docker_layer_caching: true
    - run:
        name: Login to Docker Hub
        command: |
          echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - run:
        name: Build and Push Docker Images
        command: |
          docker-compose build
          docker-compose push
    - run:
        name: Deploy to Production Server
        command: |
          ssh $SSH_USER@$SSH_HOST << 'EOF'
            cd /path/to/your/project
            docker-compose pull
            docker-compose down
            docker-compose up -d
          EOF
    environment:
      DOCKERHUB_USERNAME: your_dockerhub_username
      DOCKERHUB_PASS: your_dockerhub_password
      SSH_USER: your_ssh_username
      SSH_HOST: your_server_host
workflows:
  version: 2
  build_and_test_workflow:
    jobs:
      - build_and_test_backend
      - build_and_test_frontend
      - deploy_docker :
        requires:
          -build_and_test_backend
